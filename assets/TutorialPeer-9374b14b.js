var l=Object.defineProperty;var h=(o,t,e)=>t in o?l(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t,e)=>(h(o,typeof t!="symbol"?t+"":t,e),e);import{I as d,S as p}from"./index-2f2e5893.js";import{W as u}from"./WSClient-4a6f9690.js";class m{constructor(t){n(this,"roomId");n(this,"polite");n(this,"pc",null);n(this,"dc",null);n(this,"ws",null);n(this,"local",null);n(this,"remote",null);n(this,"screen",null);n(this,"makingOffer",!1);n(this,"lastOfferSdp","");n(this,"onStatus");n(this,"onRemoteStream");n(this,"onDataMessage");this.roomId=t.roomId,this.polite=!!t.polite}ensurePeer(){if(this.pc)return;const t=new RTCPeerConnection({iceServers:d});t.onicecandidate=e=>{e.candidate&&this.sendSignal({type:"candidate",payload:e.candidate})},t.onconnectionstatechange=()=>this.emitStatus(),t.ontrack=e=>{var s;this.remote||(this.remote=new MediaStream),this.remote.addTrack(e.track),(s=this.onRemoteStream)==null||s.call(this,this.remote)},t.ondatachannel=e=>{this.dc=e.channel,this.bindDataChannel(),this.emitStatus()},this.pc=t,this.emitStatus()}async connect(t=p){this.ensurePeer();const e=new u({url:t,heartbeatIntervalMs:8e3,heartbeatTimeoutMs:12e3});e.onStatus=()=>this.emitStatus(),e.onMessage=s=>this.handleSignal(s),await e.connect(),this.ws=e,this.sendSignal({type:"join"})}async startLocalMedia(t={audio:!0,video:!0}){return this.ensurePeer(),this.local=await navigator.mediaDevices.getUserMedia(t),this.local.getTracks().forEach(e=>this.pc.addTrack(e,this.local)),console.log("[peer] local-media started"),this.emitStatus(),this.local}async startScreenShare(){var i;this.ensurePeer();const t=navigator.mediaDevices,e=await((i=t.getDisplayMedia)==null?void 0:i.call(t,{video:!0}));if(!e)throw new Error("getDisplayMedia not available");const s=e.getVideoTracks()[0],a=this.pc.getSenders().find(c=>{var r;return((r=c.track)==null?void 0:r.kind)==="video"});return a&&s&&a.replaceTrack(s),this.screen=e,console.log("[peer] screen-share started"),e}ensureDataChannel(t="chat"){return this.ensurePeer(),(!this.dc||this.dc.readyState==="closed")&&(this.dc=this.pc.createDataChannel(t),this.bindDataChannel()),this.dc}getDataChannel(){return this.dc}sendText(t){if(!this.dc||this.dc.readyState!=="open")throw new Error("datachannel not open");this.dc.send(t)}async call(){this.ensurePeer(),this.ensureDataChannel("chat"),this.makingOffer=!0;try{const t=await this.pc.createOffer();await this.pc.setLocalDescription(t),this.sendSignal({type:"offer",payload:t})}finally{this.makingOffer=!1}}hangup(){var s;const t=this.local?this.local.getTracks():[];for(const a of t)try{a.stop()}catch{}const e=this.screen?this.screen.getTracks():[];for(const a of e)try{a.stop()}catch{}try{const a=((s=this.pc)==null?void 0:s.getSenders())||[];for(const i of a){const c=i.track;if(c)try{c.stop()}catch{}}}catch{}try{this.dc&&(this.dc.onopen=null,this.dc.onclose=null,this.dc.onmessage=null,this.dc.close())}catch{}this.dc=null;try{this.pc&&(this.pc.onicecandidate=null,this.pc.onconnectionstatechange=null,this.pc.ondatachannel=null,this.pc.ontrack=null,this.pc.close())}catch{}this.pc=null;try{this.ws&&(this.ws.onMessage=void 0,this.ws.onStatus=void 0,this.ws.disconnect(1e3,"hangup"))}catch{}this.ws=null,this.local=null,this.screen=null,this.remote=null,console.log("[peer] hangup completed"),this.emitStatus()}async handleSignal(t){const e=this.pc;if(e){if(t.type==="join"){await this.call();return}if(t.type==="offer"){const s=t.payload,a=(s==null?void 0:s.sdp)||"";if(this.lastOfferSdp===a)return;const i=this.makingOffer||e.signalingState!=="stable";if(i&&!this.polite)return;i&&await e.setLocalDescription({type:"rollback"}),await e.setRemoteDescription(s);const c=await e.createAnswer();await e.setLocalDescription(c),this.sendSignal({type:"answer",payload:c}),this.lastOfferSdp=a;return}if(t.type==="answer"){await e.setRemoteDescription(t.payload);return}if(t.type==="candidate"){try{await e.addIceCandidate(t.payload)}catch{}return}}}bindDataChannel(){this.dc&&(this.dc.onopen=()=>this.emitStatus(),this.dc.onclose=()=>this.emitStatus(),this.dc.onmessage=t=>{var e;return(e=this.onDataMessage)==null?void 0:e.call(this,t)})}sendSignal(t){this.ws&&this.ws.send({type:t.type,payload:t.payload,roomId:this.roomId})}emitStatus(){var t,e,s;(s=this.onStatus)==null||s.call(this,{pcState:((t=this.pc)==null?void 0:t.connectionState)??"closed",dcState:this.dc?this.dc.readyState:"none",wsOpen:!!this.ws&&this.ws.getStatus()==="open",roomJoined:!1,peerPresent:((e=this.pc)==null?void 0:e.connectionState)==="connected"})}}export{m as T};
