var h=Object.defineProperty;var l=(r,t,e)=>t in r?h(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var i=(r,t,e)=>(l(r,typeof t!="symbol"?t+"":t,e),e);import{I as d,S as p}from"./index-30a93734.js";import{W as u}from"./WSClient-c3269280.js";class m{constructor(t){i(this,"roomId");i(this,"polite");i(this,"pc",null);i(this,"dc",null);i(this,"ws",null);i(this,"local",null);i(this,"remote",null);i(this,"makingOffer",!1);i(this,"lastOfferSdp","");i(this,"onStatus");i(this,"onRemoteStream");i(this,"onDataMessage");this.roomId=t.roomId,this.polite=!!t.polite}ensurePeer(){if(this.pc)return;const t=new RTCPeerConnection({iceServers:d});t.onicecandidate=e=>{e.candidate&&this.sendSignal({type:"candidate",payload:e.candidate})},t.onconnectionstatechange=()=>this.emitStatus(),t.ontrack=e=>{var a;this.remote||(this.remote=new MediaStream),this.remote.addTrack(e.track),(a=this.onRemoteStream)==null||a.call(this,this.remote)},t.ondatachannel=e=>{this.dc=e.channel,this.bindDataChannel(),this.emitStatus()},this.pc=t,this.emitStatus()}async connect(t=p){this.ensurePeer();const e=new u({url:t,heartbeatIntervalMs:8e3,heartbeatTimeoutMs:12e3});e.onStatus=()=>this.emitStatus(),e.onMessage=a=>this.handleSignal(a),await e.connect(),this.ws=e,this.sendSignal({type:"join"})}async startLocalMedia(t={audio:!0,video:!0}){return this.ensurePeer(),this.local=await navigator.mediaDevices.getUserMedia(t),this.local.getTracks().forEach(e=>this.pc.addTrack(e,this.local)),this.emitStatus(),this.local}async startScreenShare(){var s;this.ensurePeer();const t=navigator.mediaDevices,e=await((s=t.getDisplayMedia)==null?void 0:s.call(t,{video:!0}));if(!e)throw new Error("getDisplayMedia not available");const a=e.getVideoTracks()[0],n=this.pc.getSenders().find(c=>{var o;return((o=c.track)==null?void 0:o.kind)==="video"});return n&&a&&n.replaceTrack(a),e}ensureDataChannel(t="chat"){return this.ensurePeer(),(!this.dc||this.dc.readyState==="closed")&&(this.dc=this.pc.createDataChannel(t),this.bindDataChannel()),this.dc}getDataChannel(){return this.dc}sendText(t){if(!this.dc||this.dc.readyState!=="open")throw new Error("datachannel not open");this.dc.send(t)}async call(){this.ensurePeer(),this.ensureDataChannel("chat"),this.makingOffer=!0;try{const t=await this.pc.createOffer();await this.pc.setLocalDescription(t),this.sendSignal({type:"offer",payload:t})}finally{this.makingOffer=!1}}hangup(){var t,e,a,n;try{(t=this.ws)==null||t.disconnect(1e3,"hangup")}catch{}this.ws=null;try{(e=this.dc)==null||e.close()}catch{}this.dc=null;try{(a=this.pc)==null||a.close()}catch{}this.pc=null,(n=this.local)==null||n.getTracks().forEach(s=>s.stop()),this.local=null,this.remote=null,this.emitStatus()}async handleSignal(t){const e=this.pc;if(e){if(t.type==="join"){await this.call();return}if(t.type==="offer"){const a=t.payload,n=(a==null?void 0:a.sdp)||"";if(this.lastOfferSdp===n)return;const s=this.makingOffer||e.signalingState!=="stable";if(s&&!this.polite)return;s&&await e.setLocalDescription({type:"rollback"}),await e.setRemoteDescription(a);const c=await e.createAnswer();await e.setLocalDescription(c),this.sendSignal({type:"answer",payload:c}),this.lastOfferSdp=n;return}if(t.type==="answer"){await e.setRemoteDescription(t.payload);return}if(t.type==="candidate"){try{await e.addIceCandidate(t.payload)}catch{}return}}}bindDataChannel(){this.dc&&(this.dc.onopen=()=>this.emitStatus(),this.dc.onclose=()=>this.emitStatus(),this.dc.onmessage=t=>{var e;return(e=this.onDataMessage)==null?void 0:e.call(this,t)})}sendSignal(t){this.ws&&this.ws.send({type:t.type,payload:t.payload,roomId:this.roomId})}emitStatus(){var t,e,a;(a=this.onStatus)==null||a.call(this,{pcState:((t=this.pc)==null?void 0:t.connectionState)??"closed",dcState:this.dc?this.dc.readyState:"none",wsOpen:!!this.ws&&this.ws.getStatus()==="open",roomJoined:!1,peerPresent:((e=this.pc)==null?void 0:e.connectionState)==="connected"})}}export{m as T};
