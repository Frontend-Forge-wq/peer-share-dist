import{r as a,j as n,a as r}from"./index-2f2e5893.js";import{T as C}from"./TutorialPeer-9374b14b.js";import"./WSClient-4a6f9690.js";function F(){const[w,S]=a.useState("ft-room"),[A,L]=a.useState("idle"),[x,T]=a.useState(0),[B,v]=a.useState(0),[b,M]=a.useState(""),[N,U]=a.useState(""),p=a.useRef(null),u=a.useRef([]),f=a.useRef(0),h=a.useRef(0);a.useEffect(()=>()=>{var e;return(e=p.current)==null?void 0:e.hangup()},[]);const z=async()=>{const e=new C({roomId:w,polite:!0});e.onStatus=t=>L(`${t.pcState}/${t.dcState}`),e.onDataMessage=t=>{if(typeof t.data=="string"&&String(t.data).startsWith("META|")){const s=String(t.data).split("|"),o=s[1]||"file",i=Number(s[2]||"0");M(o),f.current=i,h.current=0,u.current=[],v(0)}else if(t.data instanceof ArrayBuffer){const s=new Uint8Array(t.data);if(u.current.push(s),h.current+=s.byteLength,v(h.current/(f.current||1)),h.current>=f.current&&f.current>0){const o=u.current.reduce((c,l)=>c+l.byteLength,0),i=new Uint8Array(o);let m=0;for(const c of u.current)i.set(c,m),m+=c.byteLength;const d=new Blob([i]),g=URL.createObjectURL(d);U(g)}}},await e.connect(),p.current=e},P=async e=>{const t=p.current;if(!t)return;await t.call(),t.ensureDataChannel("file");const s=t.getDataChannel();t.sendText(`META|${e.name}|${e.size}`);let o=0;const i=e.stream().getReader(),m=performance.now();let d=!1;for(;!d;){const c=await i.read();if(d=c.done??!1,d)break;const l=c.value;if(s){for(s.bufferedAmountLowThreshold=256*1024;s.bufferedAmount>s.bufferedAmountLowThreshold;)await new Promise(R=>s.addEventListener("bufferedamountlow",()=>R(),{once:!0}));const $=new ArrayBuffer(l.byteLength),y=new Uint8Array($);y.set(l);try{s.send(y)}catch{}}o+=l.byteLength,T(o/e.size)}const g=Math.max(.001,(performance.now()-m)/1e3);console.log(`发送完成: ${(e.size/1024/1024).toFixed(2)}MB @ ${(e.size/g/1024).toFixed(0)} KB/s`)};return n("div",{className:"page",children:r("div",{className:"grid two",children:[r("div",{className:"card",children:[n("div",{className:"card-title",children:"文件传输"}),r("div",{className:"card-body",children:[r("div",{className:"row gap",children:[n("input",{className:"input",value:w,onChange:e=>S(e.target.value),"aria-label":"房间ID"}),n("button",{className:"btn",onClick:z,children:"连接"}),r("span",{className:"chip",children:[n("span",{className:"dot"}),A]})]}),n("div",{className:"row gap",children:n("input",{className:"input",type:"file",onChange:e=>{var s;const t=(s=e.target.files)==null?void 0:s[0];t&&P(t)}})}),r("div",{className:"row gap",children:[r("div",{className:"chip",children:["发送进度 ",Math.round(x*100),"%"]}),r("div",{className:"chip",children:["接收进度 ",Math.round(B*100),"%"]})]})]})]}),r("div",{className:"card",children:[n("div",{className:"card-title",children:"接收结果"}),n("div",{className:"card-body",children:N?r("a",{className:"btn",href:N,download:b||"download",children:["下载 ",b||"file"]}):n("div",{className:"muted",children:"等待接收..."})})]})]})})}export{F as default};
